{% extends "base.html" %}

{% block title %}HETROFL Workflow - Interactive 3D Visualization{% endblock %}

{% block extra_css %}
<!-- 3D Workflow Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/workflow-3d.css') }}">

<!-- 3D Libraries -->
<script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/gsap.min.js') }}"></script>

<!-- SEO and Social Meta Tags -->
<meta name="description" content="Interactive 3D visualization of HETROFL federated learning workflow with real-time monitoring and advanced animations">
<meta name="keywords" content="federated learning, 3D visualization, machine learning, HETROFL, workflow">
<meta property="og:title" content="HETROFL 3D Workflow Visualization">
<meta property="og:description" content="Experience federated learning in stunning 3D with real-time data flow visualization">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">

<!-- Accessibility and Performance -->
<link rel="preload" href="{{ url_for('static', filename='js/three.min.js') }}" as="script">
<link rel="preload" href="{{ url_for('static', filename='js/gsap.min.js') }}" as="script">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-project-diagram me-2 text-primary"></i>HETROFL Workflow</h2>
                    <p class="text-muted mb-0">Interactive visualization of the federated learning system workflow</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="start-animation-btn" aria-label="Start workflow animation">
                        <i class="fas fa-play me-2"></i>Start Animation
                    </button>
                    <button class="btn btn-outline-secondary" id="reset-animation-btn" aria-label="Reset view and animation">
                        <i class="fas fa-undo me-2"></i>Reset
                    </button>
                    <button class="btn btn-outline-info" id="help-btn" aria-label="Show interactive help">
                        <i class="fas fa-question-circle me-2"></i>Help
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Quality settings">
                            <i class="fas fa-cog me-2"></i>Quality
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-quality="low">Low</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="medium">Medium</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="high">High</a></li>
                            <li><a class="dropdown-item" href="#" data-quality="ultra">Ultra</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <!-- 3D Workflow Container -->
            <div class="workflow-3d-container holographic-border" id="workflow-3d-container">
                <!-- 3D Controls Panel -->
                <div class="workflow-3d-controls glass-panel-enhanced sci-fi-panel">
                    <div class="control-group">
                        <div class="control-group-title">Animation</div>
                        <div class="control-buttons">
                            <button class="control-btn" id="start-3d-animation" title="Start workflow animation (Space)">
                                <i class="fas fa-play"></i> Start
                            </button>
                            <button class="control-btn" id="pause-3d-animation" title="Pause animation">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="control-btn" id="reset-3d-animation" title="Reset workflow (R)">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-group-title">Speed</div>
                        <div class="speed-control">
                            <input type="range" class="speed-slider" id="speed-slider" 
                                   min="0.1" max="3" step="0.1" value="1" title="Animation speed">
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Slow</small>
                                <small class="text-muted">Fast</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-group-title">Camera Views</div>
                        <div class="control-buttons">
                            <button class="control-btn active" id="view-perspective" title="3D perspective view (1)">
                                <i class="fas fa-cube"></i> 3D
                            </button>
                            <button class="control-btn" id="view-top" title="Top-down view (2)">
                                <i class="fas fa-eye"></i> Top
                            </button>
                            <button class="control-btn" id="view-side" title="Side view (3)">
                                <i class="fas fa-arrows-alt-h"></i> Side
                            </button>
                            <button class="control-btn" id="view-overview" title="Overview (4)">
                                <i class="fas fa-expand"></i> Overview
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-group-title">Effects</div>
                        <div class="control-buttons">
                            <button class="control-btn active" id="toggle-particles" title="Toggle particle effects" aria-pressed="true">
                                <i class="fas fa-sparkles"></i> Particles
                            </button>
                            <button class="control-btn active" id="toggle-glow" title="Toggle glow effects" aria-pressed="true">
                                <i class="fas fa-sun"></i> Glow
                            </button>
                            <button class="control-btn active" id="toggle-fog" title="Toggle fog effects" aria-pressed="true">
                                <i class="fas fa-cloud"></i> Fog
                            </button>
                            <button class="control-btn" id="toggle-shadows" title="Toggle shadow effects" aria-pressed="false">
                                <i class="fas fa-adjust"></i> Shadows
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-group-title">Tools</div>
                        <div class="control-buttons">
                            <button class="control-btn" id="show-help" title="Show interactive help (H)" aria-label="Show help tutorial">
                                <i class="fas fa-question-circle"></i> Help
                            </button>
                            <button class="control-btn" id="toggle-fullscreen" title="Toggle fullscreen (F)" aria-label="Enter fullscreen mode">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button class="control-btn" id="reset-camera" title="Reset camera position (R)" aria-label="Reset camera to default position">
                                <i class="fas fa-home"></i> Home
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quality Controls -->
                <div class="quality-controls">
                    <button class="quality-btn" id="quality-low" title="Low quality (better performance)">Low</button>
                    <button class="quality-btn active" id="quality-medium" title="Medium quality">Med</button>
                    <button class="quality-btn" id="quality-high" title="High quality (best visuals)">High</button>
                </div>
                
                <!-- Export Controls -->
                <div class="export-controls">
                    <button class="export-btn" id="capture-screenshot" title="Capture screenshot">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="export-btn" id="start-recording" title="Start/stop video recording">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
                
                <!-- 3D Info Panel -->
                <div class="workflow-3d-info glass-panel">
                    <div class="info-header">
                        <div class="info-title">HETROFL 3D Workflow</div>
                        <div class="info-subtitle">
                            Interactive 3D visualization of heterogeneous federated learning with real-time model communication.
                        </div>
                    </div>
                    
                    <div class="info-content">
                        <ul class="workflow-steps">
                            <li class="workflow-step" id="step-1">
                                <div class="step-number">1</div>
                                <div class="step-text">Local model training on distributed datasets</div>
                            </li>
                            <li class="workflow-step" id="step-2">
                                <div class="step-number">2</div>
                                <div class="step-text">Parameter extraction and secure encoding</div>
                            </li>
                            <li class="workflow-step" id="step-3">
                                <div class="step-number">3</div>
                                <div class="step-text">Federated aggregation of model updates</div>
                            </li>
                            <li class="workflow-step" id="step-4">
                                <div class="step-number">4</div>
                                <div class="step-text">Global model optimization and validation</div>
                            </li>
                            <li class="workflow-step" id="step-5">
                                <div class="step-number">5</div>
                                <div class="step-text">Updated model distribution to clients</div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- 3D Legend -->
                <div class="workflow-3d-legend glass-panel">
                    <div class="legend-content">
                        <div class="control-group-title">Node Types</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-icon data"></div>
                                <div class="legend-text">Data Sources</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon local"></div>
                                <div class="legend-text">Local Models</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon aggregation"></div>
                                <div class="legend-text">Aggregation</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon global"></div>
                                <div class="legend-text">Global Model</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon evaluation"></div>
                                <div class="legend-text">Evaluation</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Stats -->
                <div class="performance-stats glass-panel-enhanced">
                    <div class="stats-content">
                        <div class="control-group-title">Performance</div>
                        <div class="stat-item">
                            <span class="stat-label">FPS:</span>
                            <span class="stat-value good" id="fps-counter">60</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Nodes:</span>
                            <span class="stat-value" id="node-counter">9</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Particles:</span>
                            <span class="stat-value" id="particle-counter">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Quality:</span>
                            <span class="stat-value" id="quality-indicator">Medium</span>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Progress -->
                <div class="workflow-progress">
                    <div class="progress-bar" id="workflow-progress-bar"></div>
                </div>
                
                <!-- Tooltip Container -->
                <div class="tooltip-3d" id="tooltip-3d"></div>
            </div>
        </div>
    </div>
</div>

<!-- 3D Workflow JavaScript -->
<script src="{{ url_for('static', filename='js/workflow-3d.js') }}"></script>

<script>
// 3D Workflow Integration
document.addEventListener('DOMContentLoaded', function() {
    // Control button event listeners
    const startBtn = document.getElementById('start-3d-animation');
    const pauseBtn = document.getElementById('pause-3d-animation');
    const resetBtn = document.getElementById('reset-3d-animation');
    const speedSlider = document.getElementById('speed-slider');
    
    // Legacy button integration
    const legacyStartBtn = document.getElementById('start-animation-btn');
    const legacyResetBtn = document.getElementById('reset-animation-btn');
    
    // 3D Control handlers
    if (startBtn) {
        startBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.startWorkflowAnimation();
                this.classList.add('active');
                pauseBtn.classList.remove('active');
            }
        });
    }
    
    if (pauseBtn) {
        pauseBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.pauseAnimation();
                this.classList.add('active');
                startBtn.classList.remove('active');
            }
        });
    }
    
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.resetWorkflow();
                startBtn.classList.remove('active');
                pauseBtn.classList.remove('active');
            }
        });
    }
    
    if (speedSlider) {
        speedSlider.addEventListener('input', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.setAnimationSpeed(parseFloat(this.value));
            }
        });
    }
    
    // Legacy button integration
    if (legacyStartBtn) {
        legacyStartBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.startWorkflowAnimation();
                startBtn.classList.add('active');
                pauseBtn.classList.remove('active');
            }
        });
    }
    
    if (legacyResetBtn) {
        legacyResetBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.resetWorkflow();
                startBtn.classList.remove('active');
                pauseBtn.classList.remove('active');
            }
        });
    }
    
    // View control handlers
    const viewButtons = document.querySelectorAll('[id^="view-"]');
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            viewButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const viewType = this.id.replace('view-', '');
            if (window.hetrofl3D) {
                window.hetrofl3D.setCameraView(viewType);
            }
        });
    });
    
    // Quality control handlers
    const qualityButtons = document.querySelectorAll('[id^="quality-"]');
    qualityButtons.forEach(button => {
        button.addEventListener('click', function() {
            qualityButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const quality = this.id.replace('quality-', '');
            if (window.hetrofl3D) {
                window.hetrofl3D.setQualityLevel(quality);
            }
            
            // Update quality indicator
            const qualityIndicator = document.getElementById('quality-indicator');
            if (qualityIndicator) {
                qualityIndicator.textContent = quality.charAt(0).toUpperCase() + quality.slice(1);
            }
        });
    });
    
    // Export control handlers
    const screenshotBtn = document.getElementById('capture-screenshot');
    const recordingBtn = document.getElementById('start-recording');
    let isRecording = false;
    
    if (screenshotBtn) {
        screenshotBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.captureScreenshot();
                
                // Visual feedback
                this.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            }
        });
    }
    
    if (recordingBtn) {
        recordingBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                if (!isRecording) {
                    window.hetrofl3D.startVideoCapture();
                    this.classList.add('recording');
                    this.title = 'Stop recording';
                    isRecording = true;
                } else {
                    window.hetrofl3D.stopVideoCapture();
                    this.classList.remove('recording');
                    this.title = 'Start video recording';
                    isRecording = false;
                }
            }
        });
    }
    
    // Effect toggle handlers
    const particleToggle = document.getElementById('toggle-particles');
    const glowToggle = document.getElementById('toggle-glow');
    const fogToggle = document.getElementById('toggle-fog');
    const shadowToggle = document.getElementById('toggle-shadows');
    
    if (particleToggle) {
        particleToggle.addEventListener('click', function() {
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            this.setAttribute('aria-pressed', isActive);
            
            if (window.hetrofl3D) {
                window.hetrofl3D.settingsManager.set('particles', isActive);
                if (window.hetrofl3D.particleSystem) {
                    window.hetrofl3D.particleSystem.enabled = isActive;
                }
            }
        });
    }
    
    if (glowToggle) {
        glowToggle.addEventListener('click', function() {
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            this.setAttribute('aria-pressed', isActive);
            
            if (window.hetrofl3D) {
                window.hetrofl3D.settingsManager.set('glow', isActive);
                // Apply glow setting
                Object.values(window.hetrofl3D.nodes).forEach(nodeArray => {
                    nodeArray.forEach(node => {
                        if (node.children[1]) { // Glow mesh
                            node.children[1].visible = isActive;
                        }
                    });
                });
            }
        });
    }
    
    if (fogToggle) {
        fogToggle.addEventListener('click', function() {
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            this.setAttribute('aria-pressed', isActive);
            
            if (window.hetrofl3D) {
                window.hetrofl3D.settingsManager.set('fog', isActive);
                if (window.hetrofl3D.scene) {
                    window.hetrofl3D.scene.fog = isActive ? 
                        new THREE.Fog(0x06090f, 10, 100) : null;
                }
            }
        });
    }
    
    if (shadowToggle) {
        shadowToggle.addEventListener('click', function() {
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            this.setAttribute('aria-pressed', isActive);
            
            if (window.hetrofl3D) {
                window.hetrofl3D.settingsManager.set('shadows', isActive);
                if (window.hetrofl3D.renderer) {
                    window.hetrofl3D.renderer.shadowMap.enabled = isActive;
                }
            }
        });
    }
    
    // Tool handlers
    const helpBtn = document.getElementById('show-help');
    const fullscreenBtn = document.getElementById('toggle-fullscreen');
    const resetCameraBtn = document.getElementById('reset-camera');
    
    if (helpBtn) {
        helpBtn.addEventListener('click', function() {
            if (window.hetrofl3D && window.hetrofl3D.helpSystem) {
                window.hetrofl3D.helpSystem.show();
            }
        });
    }
    
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.toggleFullscreen();
            }
        });
    }
    
    if (resetCameraBtn) {
        resetCameraBtn.addEventListener('click', function() {
            if (window.hetrofl3D) {
                window.hetrofl3D.resetCamera();
            }
        });
    }
    
    // Quality dropdown handlers
    const qualityDropdownItems = document.querySelectorAll('[data-quality]');
    qualityDropdownItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const quality = this.getAttribute('data-quality');
            
            if (window.hetrofl3D) {
                window.hetrofl3D.setQuality(quality);
            }
            
            // Update dropdown text
            const dropdownButton = document.querySelector('[data-bs-toggle="dropdown"]');
            if (dropdownButton) {
                dropdownButton.innerHTML = `<i class="fas fa-cog me-2"></i>${quality.charAt(0).toUpperCase() + quality.slice(1)}`;
            }
        });
    });
    
    // Help button in header
    const headerHelpBtn = document.getElementById('help-btn');
    if (headerHelpBtn) {
        headerHelpBtn.addEventListener('click', function() {
            if (window.hetrofl3D && window.hetrofl3D.helpSystem) {
                window.hetrofl3D.helpSystem.show();
            }
        });
    }
    
    // Performance monitoring
    function updatePerformanceStats() {
        if (window.hetrofl3D) {
            const fpsCounter = document.getElementById('fps-counter');
            const nodeCounter = document.getElementById('node-counter');
            const particleCounter = document.getElementById('particle-counter');
            
            if (fpsCounter) {
                const fps = window.hetrofl3D.fps || 60;
                fpsCounter.textContent = fps;
                fpsCounter.className = 'stat-value ' + 
                    (fps >= 50 ? 'good' : fps >= 30 ? 'warning' : 'danger');
            }
            
            if (nodeCounter) {
                const nodeCount = Object.values(window.hetrofl3D.nodes || {})
                    .reduce((total, arr) => total + arr.length, 0);
                nodeCounter.textContent = nodeCount;
            }
            
            if (particleCounter) {
                const dataParticles = window.hetrofl3D.dataParticles ? window.hetrofl3D.dataParticles.length : 0;
                const systemParticles = (window.hetrofl3D.particleSystem && window.hetrofl3D.particleSystem.particles) ? 
                                       window.hetrofl3D.particleSystem.particles.length : 0;
                const totalParticles = dataParticles + systemParticles;
                particleCounter.textContent = totalParticles;
            }
        }
    }
    
    // Workflow progress tracking
    function updateWorkflowProgress() {
        if (window.hetrofl3D && window.hetrofl3D.isAnimating) {
            const progressBar = document.getElementById('workflow-progress-bar');
            if (progressBar) {
                const totalSteps = window.hetrofl3D.workflowSteps ? window.hetrofl3D.workflowSteps.length : 7;
                const currentStep = window.hetrofl3D.currentStep || 0;
                const progress = (currentStep / totalSteps) * 100;
                progressBar.style.width = `${progress}%`;
            }
        }
    }
    
    // Tooltip system
    function setupTooltips() {
        const tooltip = document.getElementById('tooltip-3d');
        if (!tooltip) return;
        
        // Add tooltips to all control buttons
        document.querySelectorAll('[title]').forEach(element => {
            element.addEventListener('mouseenter', function(e) {
                const title = this.getAttribute('title');
                if (title) {
                    tooltip.textContent = title;
                    tooltip.classList.add('visible');
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.top - 40}px`;
                }
            });
            
            element.addEventListener('mouseleave', function() {
                tooltip.classList.remove('visible');
            });
        });
    }
    
    // Accessibility enhancements
    function setupAccessibility() {
        if (window.hetrofl3D) {
            window.hetrofl3D.enableKeyboardNavigation();
        }
        
        // Add ARIA labels
        document.querySelectorAll('.control-btn').forEach(btn => {
            if (!btn.getAttribute('aria-label')) {
                btn.setAttribute('aria-label', btn.textContent.trim() || btn.title);
            }
        });
        
        // Add role attributes
        document.querySelector('.workflow-3d-container').setAttribute('role', 'application');
        document.querySelector('.workflow-3d-container').setAttribute('aria-label', 'HETROFL 3D Workflow Visualization');
    }
    
    // Initialize all features
    setupTooltips();
    setupAccessibility();
    
    // Update stats and progress regularly
    setInterval(updatePerformanceStats, 1000);
    setInterval(updateWorkflowProgress, 100);
    
    // Keyboard shortcuts help
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F1') {
            e.preventDefault();
            alert(`HETROFL 3D Workflow Keyboard Shortcuts:
            
Space - Start/Pause animation
R - Reset workflow
1-4 - Camera views (Perspective, Top, Side, Overview)
Tab - Navigate between nodes
Enter - Select focused node
Arrow keys - Navigate nodes
Escape - Deselect node
F1 - Show this help`);
        }
    });
    
    console.log('Advanced 3D Workflow controls initialized');
    console.log('Press F1 for keyboard shortcuts help');
});
</script>
{% endblock %}
