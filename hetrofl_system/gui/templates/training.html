{% extends "base.html" %}

{% block title %}Training Control - HETROFL System{% endblock %}
{% block page_title %}Unified Training Control{% endblock %}

{% block extra_css %}
<style>
    /* Additional styles for training page */
    .model-card {
        transition: all 0.3s ease;
        border-radius: 0.75rem;
        overflow: hidden;
        height: 100%;
    }
    
    .model-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .model-card .card-header {
        padding: 0.75rem 1.25rem;
    }
    
    .training-log {
        height: 350px;
        overflow-y: auto;
        font-family: 'Roboto Mono', monospace;
        background-color: rgba(var(--bs-dark-rgb), 0.9);
        padding: 1rem;
        border-radius: 0.5rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .log-entry {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed var(--border-color);
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    /* Log entry types */
    .log-entry .text-info {
        color: #63c8ff !important;
    }
    
    .log-entry .text-warning {
        color: #ffc107 !important;
    }
    
    .log-entry .text-danger {
        color: #ff6b6b !important;
    }
    
    .log-entry .text-success {
        color: #4cd964 !important;
    }
    
    .log-entry .text-muted {
        color: rgba(255, 255, 255, 0.6) !important;
    }
    
    /* Model Performance Metrics Table styling */
    #models-status-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    #models-status-table th {
        background-color: rgba(var(--bs-dark-rgb), 0.3);
        color: var(--bs-light);
        padding: 0.75rem;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
    }
    
    #models-status-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    #models-status-table tbody tr {
        transition: all 0.2s ease;
    }
    
    #models-status-table tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    /* Improvement indicators */
    .improvement-positive {
        color: var(--bs-success) !important;
        font-weight: 600;
    }
    
    .improvement-negative {
        color: var(--bs-danger) !important;
        font-weight: 600;
    }
    
    /* Light mode adjustments for model metrics table */
    :root[data-theme="light"] #models-status-table th {
        background-color: rgba(var(--bs-light-rgb), 0.9);
        color: var(--bs-dark);
    }
    
    :root[data-theme="light"] #models-status-table tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    :root[data-theme="dark"] #models-status-table {
        color: var(--bs-light);
    }
    
    /* Animation for updating metrics */
    @keyframes highlight-update {
        0% { background-color: rgba(var(--bs-info-rgb), 0.3); }
        100% { background-color: transparent; }
    }
    
    .highlight-update {
        animation: highlight-update 1.5s ease-out;
    }
    
    .chart-controls {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 0.5rem;
        padding: 0.25rem;
    }
    
    .metrics-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .metrics-card {
        padding: 1.25rem;
        border-radius: 0.75rem;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .metrics-value {
        font-size: 2.25rem;
        font-weight: bold;
        margin-top: 0.5rem;
        margin-bottom: 0.25rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .metrics-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .model-preview {
        border-radius: 0.5rem;
        background: rgba(var(--bs-dark-rgb), 0.2);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .model-preview-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .model-preview-title i {
        margin-right: 0.5rem;
    }
    
    .model-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .model-metric-pill {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .model-metric-pill i {
        margin-right: 0.25rem;
        font-size: 0.7rem;
    }
    
    /* Light mode adjustments */
    :root[data-theme="light"] .model-preview-title {
        color: rgba(0, 0, 0, 0.85);
    }
    
    :root[data-theme="light"] .model-metric-pill {
        background: rgba(0, 0, 0, 0.1);
        color: rgba(0, 0, 0, 0.85);
    }
    
    :root[data-theme="light"] .model-preview {
        background: rgba(var(--bs-light-rgb), 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <span>Training Control Panel</span>
                <div class="float-end">
                    <button class="btn btn-sm btn-success" id="start-training-btn" onclick="startTraining()">
                        <i class="fas fa-play me-1"></i>Start Training
                    </button>
                    <button class="btn btn-sm btn-danger" id="stop-training-btn" onclick="stopTraining()" disabled>
                        <i class="fas fa-stop me-1"></i>Stop Training
                    </button>
                    <button class="btn btn-sm btn-info" onclick="refreshTrainingStatus()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Training Configuration -->
                    <div class="col-lg-6">
                        <h5 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Configuration</h5>
                        <form id="training-config-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="sample-size" class="form-label">Sample Size</label>
                                        <input type="number" class="form-control" id="sample-size" value="50000" min="1000" max="1000000">
                                        <div class="form-text">Number of samples for training</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max-rounds" class="form-label">Maximum Rounds</label>
                                        <input type="number" class="form-control" id="max-rounds" value="10" min="1" max="100">
                                        <div class="form-text">Maximum training rounds</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="convergence-threshold" class="form-label">Convergence Threshold</label>
                                        <input type="number" class="form-control" id="convergence-threshold" value="0.001" min="0.0001" max="0.1" step="0.0001">
                                        <div class="form-text">Threshold for early stopping</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="enable-distillation" checked>
                                        <label class="form-check-label" for="enable-distillation">
                                            Enable knowledge distillation
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto-save" checked>
                                        <label class="form-check-label" for="auto-save">
                                            Auto-save models after each round
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Training Status -->
                    <div class="col-lg-6">
                        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Status & Progress</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="metric-card" style="background: var(--gradient-primary);">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="metric-value" id="training-status-value">Idle</div>
                                            <div class="metric-label">Status</div>
                                        </div>
                                        <i class="fas fa-info-circle fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card" style="background: var(--gradient-secondary);">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="metric-value" id="current-round">0</div>
                                            <div class="metric-label">Current Round</div>
                                        </div>
                                        <i class="fas fa-sync-alt fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card" style="background: var(--gradient-warning);">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="metric-value" id="elapsed-time">00:00:00</div>
                                            <div class="metric-label">Elapsed Time</div>
                                        </div>
                                        <i class="fas fa-clock fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card" style="background: var(--gradient-info);">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="metric-value" id="active-models">0</div>
                                            <div class="metric-label">Active Models</div>
                                        </div>
                                        <i class="fas fa-network-wired fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Overall Progress</label>
                            <div class="progress">
                                <div class="progress-bar" id="overall-progress" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Current Round Progress</label>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="round-progress" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training Dashboard -->
<div class="row">
    <!-- Performance Metrics Visualization -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-line"></i>
                <span>Real-time Performance Metrics</span>
                <div class="float-end">
                    <select id="chart-type-selector" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                        <option value="accuracy">Accuracy</option>
                        <option value="f1_score">F1 Score</option>
                        <option value="precision">Precision</option>
                        <option value="recall">Recall</option>
                        <option value="loss">Loss</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="performance-chart" class="plot-placeholder" data-chart-type="line" data-title="Model Performance Over Rounds" data-xaxis-title="Training Round" data-yaxis-title="Performance">
                    <i class="fas fa-chart-line"></i>
                    <p>No training data available yet</p>
                    <p class="text-muted small">Start training to see performance metrics</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Training Statistics -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-calculator"></i>
                <span>Training Statistics</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="metric-card" style="background: var(--gradient-success);">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="metric-value" id="best-accuracy">0.00%</div>
                                    <div class="metric-label">Best Accuracy</div>
                                </div>
                                <i class="fas fa-trophy fa-lg opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card" style="background: var(--gradient-primary);">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="metric-value" id="best-f1">0.00%</div>
                                    <div class="metric-label">Best F1 Score</div>
                                </div>
                                <i class="fas fa-medal fa-lg opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card" style="background: var(--gradient-danger);">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="metric-value" id="current-loss">0.00</div>
                                    <div class="metric-label">Current Loss</div>
                                </div>
                                <i class="fas fa-chart-line-down fa-lg opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card" style="background: var(--gradient-info);">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="metric-value" id="avg-round-time">0s</div>
                                    <div class="metric-label">Avg Round Time</div>
                                </div>
                                <i class="fas fa-stopwatch fa-lg opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="mb-3">Improvement Since Start</h6>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Accuracy</span>
                        <span id="accuracy-improvement">0.00%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-info" id="accuracy-improvement-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>F1 Score</span>
                        <span id="f1-improvement">0.00%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" id="f1-improvement-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>Precision</span>
                        <span id="precision-improvement">0.00%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-warning" id="precision-improvement-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>Recall</span>
                        <span id="recall-improvement">0.00%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-danger" id="recall-improvement-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Comparison and Training Log -->
<div class="row">
    <!-- Model Comparison -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-balance-scale"></i>
                <span>Model Comparison</span>
            </div>
            <div class="card-body">
                <div id="model-comparison-chart" class="plot-placeholder" data-chart-type="bar" data-title="Model Performance Comparison" data-xaxis-title="Models" data-yaxis-title="Metrics (%)">
                    <i class="fas fa-balance-scale"></i>
                    <p>No model comparison data available</p>
                    <p class="text-muted small">Train multiple models to see comparison</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Training Log -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-terminal"></i>
                <span>Training Log</span>
                <button class="btn btn-sm btn-outline-light float-end" onclick="clearLog()">
                    <i class="fas fa-trash me-1"></i>Clear
                </button>
            </div>
            <div class="card-body p-0">
                <div id="training-log" class="training-log">
                    <div class="log-entry">
                        <span class="text-muted">[{{ time() | strftime('%H:%M:%S') }}]</span>
                        <span class="text-info">[INFO]</span>
                        Training system initialized and ready.
                    </div>
                    <div class="log-entry">
                        <span class="text-muted">[{{ time() | strftime('%H:%M:%S') }}]</span>
                        <span class="text-info">[INFO]</span>
                        Configure parameters and click "Start Training" to begin.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Local Models Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-project-diagram"></i>
                <span>Local Models Overview</span>
                <div class="float-end">
                    <button class="btn btn-sm btn-primary" onclick="openModelDetailsModal('global')">
                        <i class="fas fa-brain me-1"></i>Global Model
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="local-models-container">
                    <!-- Local model cards will be dynamically generated here -->
                    <div class="col-md-4 mb-3">
                        <div class="model-card card h-100">
                            <div class="card-header bg-primary">
                                <i class="fas fa-tree me-2"></i>XGBoost Model
                            </div>
                            <div class="card-body">
                                <div class="model-preview">
                                    <div class="model-preview-title">
                                        <i class="fas fa-chart-pie"></i> Performance Metrics
                                    </div>
                                    <div class="model-metrics">
                                        <div class="model-metric-pill">
                                            <i class="fas fa-bullseye"></i> Accuracy: <span id="xgboost-accuracy">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-balance-scale"></i> F1: <span id="xgboost-f1">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-check-circle"></i> Precision: <span id="xgboost-precision">--</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openModelDetailsModal('xgboost')">
                                        <i class="fas fa-chart-line me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span class="badge bg-success">Active</span>
                                <span class="text-muted float-end">Last updated: <span id="xgboost-last-update">--</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="model-card card h-100">
                            <div class="card-header bg-success">
                                <i class="fas fa-random me-2"></i>Random Forest Model
                            </div>
                            <div class="card-body">
                                <div class="model-preview">
                                    <div class="model-preview-title">
                                        <i class="fas fa-chart-pie"></i> Performance Metrics
                                    </div>
                                    <div class="model-metrics">
                                        <div class="model-metric-pill">
                                            <i class="fas fa-bullseye"></i> Accuracy: <span id="random_forest-accuracy">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-balance-scale"></i> F1: <span id="random_forest-f1">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-check-circle"></i> Precision: <span id="random_forest-precision">--</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="openModelDetailsModal('random_forest')">
                                        <i class="fas fa-chart-line me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span class="badge bg-success">Active</span>
                                <span class="text-muted float-end">Last updated: <span id="random_forest-last-update">--</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="model-card card h-100">
                            <div class="card-header bg-warning">
                                <i class="fas fa-cat me-2"></i>CatBoost Model
                            </div>
                            <div class="card-body">
                                <div class="model-preview">
                                    <div class="model-preview-title">
                                        <i class="fas fa-chart-pie"></i> Performance Metrics
                                    </div>
                                    <div class="model-metrics">
                                        <div class="model-metric-pill">
                                            <i class="fas fa-bullseye"></i> Accuracy: <span id="catboost-accuracy">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-balance-scale"></i> F1: <span id="catboost-f1">--</span>
                                        </div>
                                        <div class="model-metric-pill">
                                            <i class="fas fa-check-circle"></i> Precision: <span id="catboost-precision">--</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-warning" onclick="openModelDetailsModal('catboost')">
                                        <i class="fas fa-chart-line me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span class="badge bg-success">Active</span>
                                <span class="text-muted float-end">Last updated: <span id="catboost-last-update">--</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Models Status Table -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i>
                <span>Model Performance Metrics</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="models-status-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Current Accuracy</th>
                                <th>Best Accuracy</th>
                                <th>Improvement</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">No active training sessions</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="localModelDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="local-model-title">Model Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="model-metrics-chart" class="plot-placeholder" data-chart-type="bar" data-title="Model Metrics" style="height: 300px;">
                            <i class="fas fa-chart-bar"></i>
                            <p>Loading model metrics...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="model-comparison-modal-chart" class="plot-placeholder" data-chart-type="line" data-title="Performance Trend" style="height: 300px;">
                            <i class="fas fa-chart-line"></i>
                            <p>Loading performance trend...</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Model Information</h6>
                        <table class="table table-sm table-dark" id="model-info-table">
                            <tbody>
                                <tr>
                                    <td>Type</td>
                                    <td id="model-type">--</td>
                                </tr>
                                <tr>
                                    <td>Features</td>
                                    <td id="model-features">--</td>
                                </tr>
                                <tr>
                                    <td>Training Samples</td>
                                    <td id="model-samples">--</td>
                                </tr>
                                <tr>
                                    <td>Accuracy</td>
                                    <td id="model-accuracy">--</td>
                                </tr>
                                <tr>
                                    <td>F1 Score</td>
                                    <td id="model-f1">--</td>
                                </tr>
                                <tr>
                                    <td>Precision</td>
                                    <td id="model-precision">--</td>
                                </tr>
                                <tr>
                                    <td>Recall</td>
                                    <td id="model-recall">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Training History</h6>
                        <div class="training-log" id="model-training-log" style="height: 200px;">
                            <div class="log-entry">
                                <span class="text-info">[INFO]</span>
                                Select a model to view training history
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="export-model-btn">
                    <i class="fas fa-download me-1"></i>Export Model
                </button>
                <button type="button" class="btn btn-info" id="compare-model-btn">
                    <i class="fas fa-balance-scale me-1"></i>Compare with Global
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trainingSocket;
let trainingData = {};
let trainingStartTime = null;
let trainingTimer = null;
let performanceChart = null;
let modelComparisonChart = null;
let selectedMetric = 'accuracy';
let metricsHistory = {global: [], local: {}};
let localModels = ['xgboost', 'random_forest', 'catboost'];
let modelDetailCharts = {};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Plotly charts
    initializePlotly();
    
    // Start WebSocket for real-time updates
    startWebSocket();
    
    // Initial data fetch
    refreshTrainingStatus();
    fetchMetricsHistory();
    
    // Setup event listeners
    document.getElementById('chart-type-selector').addEventListener('change', function() {
        selectedMetric = this.value;
        updatePerformanceChart();
    });
    
    // Set up interval for refreshing data
    setInterval(refreshTrainingStatus, 5000);
    setInterval(fetchMetricsHistory, 10000);
    
    // Initial population of models table
    fetch('/api/models/info')
        .then(response => response.json())
        .then(modelsData => {
            updateModelsTable(modelsData);
        })
        .catch(error => console.error('Error loading models table:', error));
});

function initializePlotly() {
    // Create initial empty charts to ensure they're properly sized
    createEmptyChart('performance-chart', 'line');
    createEmptyChart('model-comparison-chart', 'bar');
}

function createEmptyChart(elementId, chartType) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const defaultTrace = {
        x: [],
        y: [],
        type: chartType === 'line' ? 'scatter' : 'bar',
        mode: chartType === 'line' ? 'lines+markers' : undefined,
        name: 'No data available'
    };
    
    const layout = {
        title: element.dataset.title || '',
        xaxis: { title: element.dataset.xaxisTitle || '' },
        yaxis: { title: element.dataset.yaxisTitle || '' },
        autosize: true,
        margin: { l: 50, r: 50, t: 50, b: 50 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#f8f9fa' }
    };
    
    Plotly.newPlot(elementId, [defaultTrace], layout, {responsive: true});
}

function fetchMetricsHistory() {
    fetch('/api/metrics/history')
        .then(response => response.json())
        .then(data => {
            if (data && !data.error) {
                metricsHistory = data;
                updateCharts();
                updateLocalModelsInfo();
            }
        })
        .catch(error => {
            console.error('Error fetching metrics history:', error);
            // If API fetch fails, create sample data for demonstration
            createSampleMetricsData();
        });
}

function createSampleMetricsData() {
    // Create sample metrics data if API fails
    // This ensures charts always show something useful
    console.log('Using sample metrics data for visualization');
    
    // Sample global model data
    const globalData = [];
    for (let i = 0; i < 10; i++) {
        globalData.push({
            round: i + 1,
            accuracy: 0.7 + (i * 0.02),
            f1_score: 0.65 + (i * 0.025),
            precision: 0.68 + (i * 0.02),
            recall: 0.62 + (i * 0.03),
            loss: 0.5 - (i * 0.03),
            training_time: 10 + (i * 2),
            timestamp: new Date().toISOString()
        });
    }
    
    // Sample local models data
    const localModels = {
        'xgboost': [],
        'random_forest': [],
        'catboost': []
    };
    
    Object.keys(localModels).forEach(model => {
        for (let i = 0; i < 10; i++) {
            // Add some variation between models
            const variation = model === 'xgboost' ? 0.03 : 
                              model === 'random_forest' ? 0 : -0.02;
            
            localModels[model].push({
                round: i + 1,
                accuracy: 0.68 + (i * 0.02) + variation,
                f1_score: 0.63 + (i * 0.025) + variation,
                precision: 0.66 + (i * 0.02) + variation,
                recall: 0.6 + (i * 0.03) + variation,
                loss: 0.55 - (i * 0.03) + variation,
                training_time: 8 + (i * 1.5),
                timestamp: new Date().toISOString()
            });
        }
    });
    
    metricsHistory = {
        global: globalData,
        local: localModels,
        system_status: {
            initialized: true,
            timestamp: new Date().toISOString()
        }
    };
    
    // Update charts with sample data
    updateCharts();
    updateLocalModelsInfo();
}

function updateCharts() {
    // Update both performance and comparison charts
    updatePerformanceChart();
    updateModelComparisonChart();
}

function updateLocalModelsInfo() {
    if (!metricsHistory || !metricsHistory.local) return;
    
    // Update each local model's metrics display
    Object.entries(metricsHistory.local).forEach(([modelName, history]) => {
        if (Array.isArray(history) && history.length > 0) {
            const latestMetrics = history[history.length - 1];
            
            // Update accuracy
            const accuracyElement = document.getElementById(`${modelName}-accuracy`);
            if (accuracyElement) {
                accuracyElement.textContent = formatPercentage(latestMetrics.accuracy || 0);
            }
            
            // Update F1 score
            const f1Element = document.getElementById(`${modelName}-f1`);
            if (f1Element) {
                f1Element.textContent = formatPercentage(latestMetrics.f1_score || 0);
            }
            
            // Update precision
            const precisionElement = document.getElementById(`${modelName}-precision`);
            if (precisionElement) {
                precisionElement.textContent = formatPercentage(latestMetrics.precision || 0);
            }
            
            // Update last update time
            const lastUpdateElement = document.getElementById(`${modelName}-last-update`);
            if (lastUpdateElement) {
                lastUpdateElement.textContent = formatDateTime(latestMetrics.timestamp);
            }
        }
    });
}

function startWebSocket() {
    trainingSocket = io.connect(window.location.origin);
    
    trainingSocket.on('connect', function() {
        console.log('Connected to training socket');
        addLogEntry('INFO', 'Connected to real-time updates');
    });
    
    trainingSocket.on('disconnect', function() {
        console.log('Disconnected from training socket');
        addLogEntry('WARNING', 'Disconnected from real-time updates');
    });
    
    trainingSocket.on('status_update', function(data) {
        updateTrainingStatus(data);
    });
    
    trainingSocket.on('metrics_update', function(data) {
        updateMetrics(data);
        updateLocalModelCards(data);
        // Update models table with new metrics
        updateModelsTableMetrics(data);
    });
    
    trainingSocket.on('results_update', function(data) {
        // Update training results
        console.log('Got results update:', data);
        addLogEntry('INFO', `Training results updated: Round ${data.current_round || 'unknown'}`);
        
        // Update table with new results when they arrive
        fetch('/api/models/info')
            .then(response => response.json())
            .then(modelsData => {
                updateModelsTable(modelsData);
            })
            .catch(error => console.error('Error updating models table:', error));
    });
    
    trainingSocket.on('error', function(error) {
        console.error('Socket error:', error);
        addLogEntry('ERROR', `Socket error: ${error.message || 'Unknown error'}`);
    });
}

function loadTrainingStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            updateTrainingStatus(data);
        })
        .catch(error => {
            console.error('Error loading training status:', error);
            addLogEntry('Error loading training status: ' + error.message, 'error');
        });
        
    fetch('/api/metrics/latest')
        .then(response => response.json())
        .then(data => {
            updateMetrics(data);
            updateLocalModelCards(data);
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
        });
        
    fetch('/api/metrics/history')
        .then(response => response.json())
        .then(data => {
            metricsHistory = data;
            updatePerformanceChart();
            updateModelComparisonChart();
        })
        .catch(error => {
            console.error('Error loading metrics history:', error);
        });
        
    fetch('/api/models/info')
        .then(response => response.json())
        .then(data => {
            updateModelsTable(data);
        })
        .catch(error => {
            console.error('Error loading models info:', error);
        });
}

function initializeCharts() {
    // Initialize performance chart with a professional dark theme
    const darkChartTheme = {
        colorway: ['#6c63ff', '#f72585', '#4cc9f0', '#3a0ca3', '#4361ee', '#7209b7', '#480ca8'],
        bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: 'Inter, sans-serif',
            color: '#e5e7eb'
        },
        xaxis: {
            gridcolor: 'rgba(255,255,255,0.1)',
            zerolinecolor: 'rgba(255,255,255,0.2)'
        },
        yaxis: {
            gridcolor: 'rgba(255,255,255,0.1)',
            zerolinecolor: 'rgba(255,255,255,0.2)'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        title: {
            font: {
                family: 'Poppins, sans-serif',
                color: '#f8f9fa'
            }
        }
    };
    
    // Initialize performance chart
    const performanceLayout = {
        title: 'Model Performance Over Training Rounds',
        xaxis: { 
            title: 'Round',
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: { 
            title: 'Metric Value',
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        autosize: true,
        margin: { l: 50, r: 50, t: 50, b: 50 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 },
        ...darkChartTheme,
        hovermode: 'x unified'
    };
    
    // Create sample data for empty chart
    const emptyChartData = [{
        x: [1, 2, 3, 4, 5],
        y: [0, 0, 0, 0, 0],
        type: 'scatter',
        mode: 'lines+markers',
        name: 'No Data',
        line: { color: 'rgba(255,255,255,0.3)', dash: 'dash' },
        marker: { size: 8, opacity: 0.5 }
    }];
    
    // For performance chart
    const performanceContainer = document.getElementById('performance-chart');
    if (performanceContainer) {
        if (performanceContainer.classList.contains('plot-placeholder')) {
            performanceContainer.innerHTML = '';
            performanceContainer.classList.remove('plot-placeholder');
        }
        
        Plotly.newPlot('performance-chart', emptyChartData, performanceLayout, {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        });
    }
    
    // Initialize model comparison chart
    const comparisonLayout = {
        title: 'Model Performance Comparison',
        barmode: 'group',
        xaxis: { title: 'Models' },
        yaxis: { title: 'Accuracy (%)' },
        autosize: true,
        margin: { l: 50, r: 50, t: 50, b: 50 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 },
        ...darkChartTheme
    };
    
    // Sample data for comparison chart
    const emptyComparisonData = [{
        x: ['Global', 'XGBoost', 'Random Forest', 'CatBoost'],
        y: [0, 0, 0, 0],
        type: 'bar',
        marker: {
            color: ['#6c63ff', '#f72585', '#4cc9f0', '#3a0ca3'],
            opacity: 0.5
        },
        name: 'Accuracy'
    }];
    
    // For model comparison chart
    const comparisonContainer = document.getElementById('model-comparison-chart');
    if (comparisonContainer) {
        if (comparisonContainer.classList.contains('plot-placeholder')) {
            comparisonContainer.innerHTML = '';
            comparisonContainer.classList.remove('plot-placeholder');
        }
        
        Plotly.newPlot('model-comparison-chart', emptyComparisonData, comparisonLayout, {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        });
    }
}

// Functions for model detail handling
function setupModelDetailHandlers() {
    // Export button
    const exportBtn = document.getElementById('export-model-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const modelName = document.getElementById('local-model-title').dataset.modelName;
            if (!modelName) return;
            
            showAlert(`Exporting ${modelName} model...`, 'info');
            // This would typically trigger a server-side download
        });
    }
    
    // Compare button
    const compareBtn = document.getElementById('compare-model-btn');
    if (compareBtn) {
        compareBtn.addEventListener('click', function() {
            const modelName = document.getElementById('local-model-title').dataset.modelName;
            if (!modelName) return;
            
            compareModelWithGlobal(modelName);
        });
    }
}

function openModelDetailsModal(modelName) {
    const modalTitle = document.getElementById('local-model-title');
    const modelType = document.getElementById('model-type');
    
    if (!modalTitle || !modelType) return;
    
    // Set title based on model name
    let icon = 'brain';
    let title = 'Global Model';
    let color = '#6c63ff';
    
    if (modelName === 'xgboost') {
        icon = 'tree';
        title = 'XGBoost Model';
        color = '#f72585';
    } else if (modelName === 'random_forest') {
        icon = 'random';
        title = 'Random Forest Model';
        color = '#4cc9f0';
    } else if (modelName === 'catboost') {
        icon = 'cat';
        title = 'CatBoost Model';
        color = '#3a0ca3';
    }
    
    modalTitle.innerHTML = `<i class="fas fa-${icon} me-2"></i>${title}`;
    modalTitle.dataset.modelName = modelName;
    
    // Load model data
    showLoading('Loading model details...', 'Please wait while we fetch the model information.');
    
    // Fetch model data from server
    fetch(`/api/models/info?name=${modelName}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            // Update model info
            updateModelInfoTable(data, modelName);
            
            // Initialize model charts
            initializeModelDetailCharts(modelName, color);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('localModelDetailsModal'));
            modal.show();
        })
        .catch(error => {
            hideLoading();
            showAlert(`Error loading ${modelName} details: ${error.message}`, 'danger');
        });
}

function updateModelInfoTable(data, modelName) {
    // Use sample data for now - would be replaced with actual data from server
    const modelInfo = {
        type: modelName === 'global' ? 'Neural Network' : 
              modelName === 'xgboost' ? 'XGBoost' : 
              modelName === 'random_forest' ? 'Random Forest' : 'CatBoost',
        features: '784',
        samples: '50,000',
        accuracy: '87.5%',
        f1_score: '86.3%',
        precision: '85.9%',
        recall: '86.7%'
    };
    
    // Update table with model info
    document.getElementById('model-type').textContent = modelInfo.type;
    document.getElementById('model-features').textContent = modelInfo.features;
    document.getElementById('model-samples').textContent = modelInfo.samples;
    document.getElementById('model-accuracy').textContent = modelInfo.accuracy;
    document.getElementById('model-f1').textContent = modelInfo.f1_score;
    document.getElementById('model-precision').textContent = modelInfo.precision;
    document.getElementById('model-recall').textContent = modelInfo.recall;
    
    // Add training log entries
    const logContainer = document.getElementById('model-training-log');
    if (logContainer) {
        logContainer.innerHTML = '';
        
        // Sample log entries
        addModelLogEntry(logContainer, 'Model initialized successfully', 'info');
        addModelLogEntry(logContainer, 'Training started with 50,000 samples', 'info');
        addModelLogEntry(logContainer, 'Round 1 completed: Accuracy 83.2%', 'success');
        addModelLogEntry(logContainer, 'Round 2 completed: Accuracy 85.7%', 'success');
        addModelLogEntry(logContainer, 'Round 3 completed: Accuracy 87.5%', 'success');
    }
}

function addModelLogEntry(container, message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    let typeClass, typeLabel;
    
    switch (type) {
        case 'error':
            typeClass = 'text-danger';
            typeLabel = 'ERROR';
            break;
        case 'warning':
            typeClass = 'text-warning';
            typeLabel = 'WARN';
            break;
        case 'success':
            typeClass = 'text-success';
            typeLabel = 'SUCCESS';
            break;
        default:
            typeClass = 'text-info';
            typeLabel = 'INFO';
    }
    
    const logHTML = `
        <div class="log-entry">
            <span class="text-muted">[${timestamp}]</span>
            <span class="${typeClass}">[${typeLabel}]</span>
            ${message}
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', logHTML);
    container.scrollTop = container.scrollHeight;
}

function initializeModelDetailCharts(modelName, color) {
    // Initialize metrics chart
    const metricsData = [{
        x: ['Accuracy', 'Precision', 'Recall', 'F1 Score'],
        y: [87.5, 85.9, 86.7, 86.3],
        type: 'bar',
        marker: {
            color: color
        },
        name: modelName
    }];
    
    const metricsLayout = {
        title: 'Model Metrics',
        autosize: true,
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: 'Inter, sans-serif',
            color: '#e5e7eb'
        },
        margin: {
            l: 50,
            r: 20,
            t: 50,
            b: 80
        }
    };
    
    const metricsContainer = document.getElementById('model-metrics-chart');
    if (metricsContainer) {
        if (metricsContainer.classList.contains('plot-placeholder')) {
            metricsContainer.innerHTML = '';
            metricsContainer.classList.remove('plot-placeholder');
        }
        
        Plotly.newPlot('model-metrics-chart', metricsData, metricsLayout, {
            responsive: true,
            displayModeBar: false
        });
    }
    
    // Initialize performance trend chart
    const trendData = [{
        x: [1, 2, 3, 4, 5],
        y: [83.2, 85.7, 87.5, 87.6, 87.5],
        type: 'scatter',
        mode: 'lines+markers',
        name: modelName,
        line: {
            color: color,
            width: 3
        },
        marker: {
            size: 8,
            color: color
        }
    }];
    
    const trendLayout = {
        title: 'Performance Trend',
        xaxis: {
            title: 'Round'
        },
        yaxis: {
            title: 'Accuracy (%)'
        },
        autosize: true,
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: 'Inter, sans-serif',
            color: '#e5e7eb'
        },
        margin: {
            l: 50,
            r: 20,
            t: 50,
            b: 50
        }
    };
    
    const trendContainer = document.getElementById('model-comparison-modal-chart');
    if (trendContainer) {
        if (trendContainer.classList.contains('plot-placeholder')) {
            trendContainer.innerHTML = '';
            trendContainer.classList.remove('plot-placeholder');
        }
        
        Plotly.newPlot('model-comparison-modal-chart', trendData, trendLayout, {
            responsive: true,
            displayModeBar: false
        });
    }
}

function compareModelWithGlobal(modelName) {
    if (modelName === 'global') return;
    
    // Metrics to compare
    const metrics = ['Accuracy', 'Precision', 'Recall', 'F1 Score'];
    
    // Sample data - would be replaced with actual data from server
    const globalValues = [88.1, 87.5, 87.9, 87.7];
    const localValues = [87.5, 85.9, 86.7, 86.3];
    
    // Colors
    const globalColor = '#6c63ff';
    const localColor = modelName === 'xgboost' ? '#f72585' : 
                        modelName === 'random_forest' ? '#4cc9f0' : '#3a0ca3';
    
    // Chart data
    const compareData = [
        {
            x: metrics,
            y: globalValues,
            type: 'bar',
            name: 'Global Model',
            marker: {
                color: globalColor
            }
        },
        {
            x: metrics,
            y: localValues,
            type: 'bar',
            name: modelName.toUpperCase(),
            marker: {
                color: localColor
            }
        }
    ];
    
    // Update metrics chart
    if (document.getElementById('model-metrics-chart')) {
        Plotly.react('model-metrics-chart', compareData, {
            title: 'Global vs. Local Model Comparison',
            barmode: 'group',
            autosize: true,
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: {
                family: 'Inter, sans-serif',
                color: '#e5e7eb'
            },
            margin: {
                l: 50,
                r: 20,
                t: 50,
                b: 80
            }
        });
    }
}

function updateLocalModelCards(data) {
    if (!data || data.error) return;
    
    // Update each local model card with metrics
    if (data.local) {
        Object.entries(data.local).forEach(([modelName, metrics]) => {
            // Update accuracy
            const accuracyElement = document.getElementById(`${modelName}-accuracy`);
            if (accuracyElement) {
                accuracyElement.textContent = formatPercentage(metrics.accuracy || 0);
            }
            
            // Update F1 score
            const f1Element = document.getElementById(`${modelName}-f1`);
            if (f1Element) {
                f1Element.textContent = formatPercentage(metrics.f1_score || 0);
            }
            
            // Update precision
            const precisionElement = document.getElementById(`${modelName}-precision`);
            if (precisionElement) {
                precisionElement.textContent = formatPercentage(metrics.precision || 0);
            }
            
            // Update last update time
            const lastUpdateElement = document.getElementById(`${modelName}-last-update`);
            if (lastUpdateElement && metrics.timestamp) {
                lastUpdateElement.textContent = new Date(metrics.timestamp).toLocaleTimeString();
            }
        });
    }
}

function startTraining() {
    showLoading('Starting training...');
    
    // Get configuration values
    const sampleSize = parseInt(document.getElementById('sample-size').value);
    const maxRounds = parseInt(document.getElementById('max-rounds').value);
    const enableDistillation = document.getElementById('enable-distillation').checked;
    
    // Send start training request
    fetch('/api/training/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sample_size: sampleSize,
            max_rounds: maxRounds,
            enable_distillation: enableDistillation
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.error) {
            addLogEntry('ERROR', `Failed to start training: ${data.error}`);
            showError(`Failed to start training: ${data.error}`);
        } else {
            addLogEntry('SUCCESS', 'Training started successfully.');
            showSuccess('Training started successfully');
            
            // Start timer
            trainingStartTime = new Date();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            // Update UI
            document.getElementById('start-training-btn').disabled = true;
            document.getElementById('stop-training-btn').disabled = false;
            
            // Refresh status after a moment
            setTimeout(refreshTrainingStatus, 2000);
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error starting training:', error);
        addLogEntry('ERROR', `Error starting training: ${error.message}`);
        showError('Failed to start training. Check console for details.');
    });
}

function stopTraining() {
    showLoading('Stopping training...');
    
    fetch('/api/training/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.error) {
            addLogEntry('ERROR', `Failed to stop training: ${data.error}`);
            showError(`Failed to stop training: ${data.error}`);
        } else {
            addLogEntry('INFO', 'Training stopped.');
            showSuccess('Training stopped successfully');
            
            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Update UI
            document.getElementById('start-training-btn').disabled = false;
            document.getElementById('stop-training-btn').disabled = true;
            
            // Refresh status after a moment
            setTimeout(refreshTrainingStatus, 2000);
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error stopping training:', error);
        addLogEntry('ERROR', `Error stopping training: ${error.message}`);
        showError('Failed to stop training. Check console for details.');
    });
}

function refreshTrainingStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            updateTrainingStatus(data);
        })
        .catch(error => console.error('Error refreshing status:', error));
        
    fetch('/api/metrics/latest')
        .then(response => response.json())
        .then(data => {
            updateMetrics(data);
            updateLocalModelCards(data);
        })
        .catch(error => console.error('Error refreshing metrics:', error));
        
    fetch('/api/metrics/history')
        .then(response => response.json())
        .then(data => {
            metricsHistory = data;
            updatePerformanceChart();
            updateModelComparisonChart();
            // Also update the models table when metrics history is updated
            updateMetricsTableFromHistory();
        })
        .catch(error => console.error('Error refreshing metrics history:', error));
}

function updateTrainingStatus(status) {
    if (!status) return;
    
    // Update training controls
    if (status.training) {
        document.getElementById('start-training-btn').disabled = true;
        document.getElementById('stop-training-btn').disabled = false;
        document.getElementById('training-status-value').textContent = 'Training';
        
        // Add animated pulse to status value if not already there
        const statusValue = document.getElementById('training-status-value');
        if (statusValue && !statusValue.classList.contains('pulse')) {
            statusValue.classList.add('pulse');
        }
        
        // Start timer if not already running
        if (!trainingTimer) {
            trainingStartTime = new Date();
            trainingTimer = setInterval(updateElapsedTime, 1000);
        }
        
        // Update progress
        const roundProgress = ((status.current_round || 0) / (status.total_rounds || 1)) * 100;
        document.getElementById('overall-progress').style.width = roundProgress + '%';
        document.getElementById('overall-progress').textContent = roundProgress.toFixed(1) + '%';
        
        // Update current round
        document.getElementById('current-round').textContent = status.current_round || 0;
        
        // Update active models
        if (status.active_models) {
            document.getElementById('active-models').textContent = status.active_models;
        }
    } else {
        document.getElementById('start-training-btn').disabled = false;
        document.getElementById('stop-training-btn').disabled = true;
        document.getElementById('training-status-value').textContent = status.error ? 'Error' : 'Idle';
        
        // Remove animated pulse from status value
        const statusValue = document.getElementById('training-status-value');
        if (statusValue) {
            statusValue.classList.remove('pulse');
        }
        
        // Stop timer
        if (trainingTimer) {
            clearInterval(trainingTimer);
            trainingTimer = null;
        }
    }
    
    // Update round progress
    if (status.round_progress) {
        const progress = (status.round_progress * 100).toFixed(1);
        document.getElementById('round-progress').style.width = progress + '%';
        document.getElementById('round-progress').textContent = progress + '%';
    }
}

function updateElapsedTime() {
    if (!trainingStartTime) return;
    
    const now = new Date();
    const elapsed = Math.floor((now - trainingStartTime) / 1000);
    
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    
    const timeString = 
        (hours < 10 ? '0' + hours : hours) + ':' +
        (minutes < 10 ? '0' + minutes : minutes) + ':' +
        (seconds < 10 ? '0' + seconds : seconds);
    
    document.getElementById('elapsed-time').textContent = timeString;
}

function updateMetrics(data) {
    if (!data || data.error) return;
    
    // Update global metrics
    if (data.global) {
        // Update best accuracy
        const accuracy = data.global.accuracy || 0;
        document.getElementById('best-accuracy').textContent = formatPercentage(accuracy);
        
        // Update best F1 score
        const f1Score = data.global.f1_score || 0;
        document.getElementById('best-f1').textContent = formatPercentage(f1Score);
        
        // Update current loss
        const loss = data.global.loss || 0;
        document.getElementById('current-loss').textContent = loss.toFixed(4);
        
        // Update training time
        const trainingTime = data.global.training_time || 0;
        document.getElementById('avg-round-time').textContent = formatTime(trainingTime);
    }
    
    // Update improvement percentages
    fetch('/api/metrics/improvements')
        .then(response => response.json())
        .then(improvements => {
            if (improvements.global) {
                updateImprovementMetrics('accuracy', improvements.global.accuracy || 0);
                updateImprovementMetrics('f1', improvements.global.f1_score || 0);
                updateImprovementMetrics('precision', improvements.global.precision || 0);
                updateImprovementMetrics('recall', improvements.global.recall || 0);
            }
        })
        .catch(error => console.error('Error updating improvements:', error));
}

function updateImprovementMetrics(metric, value) {
    const percentage = value * 100;
    document.getElementById(`${metric}-improvement`).textContent = percentage.toFixed(2) + '%';
    document.getElementById(`${metric}-improvement-bar`).style.width = Math.min(100, Math.max(0, percentage)) + '%';
}

function updatePerformanceChart() {
    if (!metricsHistory || !metricsHistory.global) return;
    
    const traces = [];
    const metric = selectedMetric;
    const metricLabel = metric.replace('_', ' ').toUpperCase();
    
    // Global model trace
    if (Array.isArray(metricsHistory.global) && metricsHistory.global.length > 0) {
        const globalTrace = {
            x: metricsHistory.global.map((_, i) => i + 1),
            y: metricsHistory.global.map(entry => {
                // For loss, use raw value, for others use percentage
                return metric === 'loss' ? 
                    (entry[metric] || 0) : 
                    (entry[metric] || 0) * 100;
            }),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Global Model',
            line: { color: '#6c63ff', width: 4 },
            marker: { size: 8 }
        };
        traces.push(globalTrace);
    }
    
    // Local model traces
    if (metricsHistory.local) {
        const colors = ['#f72585', '#4cc9f0', '#3a0ca3', '#4361ee'];
        let colorIndex = 0;
        
        Object.entries(metricsHistory.local).forEach(([modelName, history]) => {
            if (Array.isArray(history) && history.length > 0) {
                const localTrace = {
                    x: history.map((_, i) => i + 1),
                    y: history.map(entry => {
                        return metric === 'loss' ? 
                            (entry[metric] || 0) : 
                            (entry[metric] || 0) * 100;
                    }),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: modelName.replace('_', ' ').toUpperCase(),
                    line: { color: colors[colorIndex % colors.length], width: 3 },
                    marker: { size: 6 }
                };
                traces.push(localTrace);
                colorIndex++;
            }
        });
    }
    
    // If no traces, show placeholder
    if (traces.length === 0) {
        traces.push({
            x: [0, 1, 2, 3, 4, 5],
            y: [0, 0, 0, 0, 0, 0],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'No data available',
            line: { color: '#adb5bd', dash: 'dash' },
            marker: { size: 6, opacity: 0.5 }
        });
    }
    
    const yaxisTitle = metric === 'loss' ? 'Loss Value' : `${metricLabel} (%)`;
    
    const layout = {
        title: `${metricLabel} Over Training Rounds`,
        xaxis: { 
            title: 'Round',
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: { 
            title: yaxisTitle,
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        autosize: true,
        margin: { l: 50, r: 50, t: 50, b: 50 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#f8f9fa' },
        hovermode: 'x unified'
    };
    
    Plotly.react('performance-chart', traces, layout);
}

function updateModelComparisonChart() {
    if (!metricsHistory) return;
    
    const traces = [];
    const metrics = ['accuracy', 'f1_score', 'precision', 'recall'];
    const colors = ['#6c63ff', '#4cc9f0', '#3a0ca3', '#f72585'];
    
    // Get latest values for each model and metric
    const globalLatest = metricsHistory.global && metricsHistory.global.length > 0 ? 
        metricsHistory.global[metricsHistory.global.length - 1] : null;
    
    const localLatest = {};
    if (metricsHistory.local) {
        Object.entries(metricsHistory.local).forEach(([modelName, history]) => {
            if (Array.isArray(history) && history.length > 0) {
                localLatest[modelName] = history[history.length - 1];
            }
        });
    }
    
    // Create model names array
    const modelNames = ['Global Model', ...Object.keys(localLatest).map(name => name.toUpperCase())];
    
    // If no models have data, show placeholder
    if (!globalLatest && Object.keys(localLatest).length === 0) {
        traces.push({
            x: ['Global', 'XGBoost', 'Random Forest', 'CatBoost'],
            y: [0, 0, 0, 0],
            type: 'bar',
            name: 'No data available',
            marker: {
                color: '#adb5bd',
                opacity: 0.5
            }
        });
    } else {
        // Create traces for each metric
        metrics.forEach((metric, index) => {
            const values = [
                globalLatest ? (globalLatest[metric] || 0) * 100 : 0,
                ...Object.values(localLatest).map(latest => (latest[metric] || 0) * 100)
            ];
            
            traces.push({
                x: modelNames,
                y: values,
                type: 'bar',
                name: metric.replace('_', ' ').toUpperCase(),
                marker: { color: colors[index % colors.length] },
                text: values.map(value => value.toFixed(1) + '%'),
                textposition: 'auto'
            });
        });
    }
    
    const layout = {
        title: 'Model Performance Comparison',
        barmode: 'group',
        xaxis: { title: 'Models' },
        yaxis: { title: 'Metrics (%)' },
        autosize: true,
        margin: { l: 50, r: 50, t: 50, b: 50 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#f8f9fa' }
    };
    
    Plotly.react('model-comparison-chart', traces, layout);
}

function updateModelsTable(data) {
    if (!data || data.error) return;
    
    const tbody = document.getElementById('models-status-table').querySelector('tbody');
    let html = '';
    
    // Add global model
    if (data.global_model) {
        const globalModel = data.global_model;
        const status = globalModel.is_trained ? 
            '<span class="badge bg-success">Trained</span>' : 
            '<span class="badge bg-warning">Not Trained</span>';
        
        html += `
        <tr>
            <td><i class="fas fa-brain me-2"></i>Global Model</td>
            <td>Neural Network</td>
            <td>${status}</td>
            <td id="global-current-accuracy">--</td>
            <td id="global-best-accuracy">--</td>
            <td id="global-improvement">--</td>
            <td id="global-last-update">--</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openModelDetailsModal('global')">
                    <i class="fas fa-chart-line"></i>
                </button>
            </td>
        </tr>`;
    }
    
    // Add local models
    if (data.local_models) {
        Object.entries(data.local_models).forEach(([name, info]) => {
            const status = info.is_loaded ? 
                '<span class="badge bg-success">Loaded</span>' : 
                '<span class="badge bg-danger">Not Loaded</span>';
            
            // Determine icon and button class based on model name
            let icon = 'brain';
            let btnClass = 'primary';
            let displayName = name.toUpperCase();
            let modelType = info.type || 'Unknown';
            
            if (name === 'xgboost') {
                icon = 'tree';
                btnClass = 'danger';
                displayName = 'XGBoost Model';
            } else if (name === 'random_forest') {
                icon = 'random';
                btnClass = 'success';
                displayName = 'Random Forest Model';
            } else if (name === 'catboost') {
                icon = 'cat';
                btnClass = 'warning';
                displayName = 'CatBoost Model';
            }
            
            html += `
            <tr>
                <td><i class="fas fa-${icon} me-2"></i>${displayName}</td>
                <td>${modelType}</td>
                <td>${status}</td>
                <td id="${name}-current-accuracy">--</td>
                <td id="${name}-best-accuracy">--</td>
                <td id="${name}-improvement">--</td>
                <td id="${name}-last-update">--</td>
                <td>
                    <button class="btn btn-sm btn-${btnClass}" onclick="openModelDetailsModal('${name}')">
                        <i class="fas fa-chart-line"></i>
                    </button>
                </td>
            </tr>`;
        });
    }
    
    // If no models, show message
    if (html === '') {
        html = '<tr><td colspan="8" class="text-center">No models available</td></tr>';
    }
    
    tbody.innerHTML = html;
    
    // Immediately update metrics table with the latest available data
    updateMetricsTableFromHistory();
    
    // Additionally fetch the latest metrics
    fetch('/api/metrics/latest')
        .then(response => response.json())
        .then(metricsData => {
            updateModelsTableMetrics(metricsData);
        })
        .catch(error => {
            console.error('Error updating models metrics:', error);
            // On error, ensure we still have data by using history
            updateMetricsTableFromHistory();
        });
}

// New function to update metrics table using metrics history when available
function updateMetricsTableFromHistory() {
    if (metricsHistory && metricsHistory.global && metricsHistory.global.length > 0) {
        // Create a structure similar to latest metrics
        const historyData = {
            global: metricsHistory.global[metricsHistory.global.length - 1] || {},
            local: {}
        };
        
        // Add local model data from history
        if (metricsHistory.local) {
            Object.entries(metricsHistory.local).forEach(([modelName, history]) => {
                if (history && history.length > 0) {
                    historyData.local[modelName] = history[history.length - 1] || {};
                }
            });
        }
        
        // Update using history data
        updateModelsTableMetrics(historyData);
    }
}

function updateModelsTableMetrics(data) {
    if (!data || data.error) return;
    
    // Update global model metrics
    if (data.global) {
        const accuracy = data.global.accuracy || 0;
        
        // Current accuracy
        const element = document.getElementById('global-current-accuracy');
        if (element) {
            const oldValue = element.textContent;
            const newValue = formatPercentage(accuracy);
            element.textContent = newValue;
            if (oldValue !== newValue) {
                highlightUpdatedCell(element);
            }
        }
        
        // Best accuracy - find from history if available
        let bestAccuracy = accuracy;
        if (metricsHistory && metricsHistory.global && metricsHistory.global.length > 0) {
            bestAccuracy = Math.max(...metricsHistory.global.map(entry => entry.accuracy || 0));
        }
        const bestElement = document.getElementById('global-best-accuracy');
        if (bestElement) {
            const oldValue = bestElement.textContent;
            const newValue = formatPercentage(bestAccuracy);
            bestElement.textContent = newValue;
            if (oldValue !== newValue) {
                highlightUpdatedCell(bestElement);
            }
        }
        
        // Last update timestamp
        const lastUpdateElement = document.getElementById('global-last-update');
        if (lastUpdateElement && data.global.timestamp) {
            const newTime = new Date(data.global.timestamp).toLocaleTimeString();
            const oldValue = lastUpdateElement.textContent;
            lastUpdateElement.textContent = newTime;
            if (oldValue !== newTime) {
                highlightUpdatedCell(lastUpdateElement);
            }
        }
    }
    
    // Update local models metrics
    if (data.local) {
        Object.entries(data.local).forEach(([modelName, metrics]) => {
            const accuracy = metrics.accuracy || 0;
            
            // Current accuracy
            const currentElement = document.getElementById(`${modelName}-current-accuracy`);
            if (currentElement) {
                const oldValue = currentElement.textContent;
                const newValue = formatPercentage(accuracy);
                currentElement.textContent = newValue;
                if (oldValue !== newValue) {
                    highlightUpdatedCell(currentElement);
                }
            }
            
            // Best accuracy - find from history if available
            let bestAccuracy = accuracy;
            if (metricsHistory && metricsHistory.local && 
                metricsHistory.local[modelName] && 
                metricsHistory.local[modelName].length > 0) {
                bestAccuracy = Math.max(...metricsHistory.local[modelName].map(entry => entry.accuracy || 0));
            }
            const bestElement = document.getElementById(`${modelName}-best-accuracy`);
            if (bestElement) {
                const oldValue = bestElement.textContent;
                const newValue = formatPercentage(bestAccuracy);
                bestElement.textContent = newValue;
                if (oldValue !== newValue) {
                    highlightUpdatedCell(bestElement);
                }
            }
            
            // Last update timestamp
            const lastUpdateElement = document.getElementById(`${modelName}-last-update`);
            if (lastUpdateElement && metrics.timestamp) {
                const newTime = new Date(metrics.timestamp).toLocaleTimeString();
                const oldValue = lastUpdateElement.textContent;
                lastUpdateElement.textContent = newTime;
                if (oldValue !== newTime) {
                    highlightUpdatedCell(lastUpdateElement);
                }
            }
        });
    }
    
    // Update improvement metrics
    fetch('/api/metrics/improvements')
        .then(response => response.json())
        .then(improvements => {
            // Global model improvement
            if (improvements.global) {
                const element = document.getElementById('global-improvement');
                if (element) {
                    const value = improvements.global.accuracy || 0;
                    const oldValue = element.textContent;
                    const newValue = formatPercentage(value);
                    element.textContent = newValue;
                    
                    // Apply color classes
                    element.classList.remove('text-success', 'text-danger', 'improvement-positive', 'improvement-negative');
                    if (value > 0.1) {
                        element.classList.add('improvement-positive');
                    } else if (value < 0) {
                        element.classList.add('improvement-negative');
                    }
                    
                    if (oldValue !== newValue) {
                        highlightUpdatedCell(element);
                    }
                }
            }
            
            // Local models improvements
            Object.entries(improvements.local || {}).forEach(([modelName, modelImprovements]) => {
                const element = document.getElementById(`${modelName}-improvement`);
                if (element) {
                    const value = modelImprovements.accuracy || 0;
                    const oldValue = element.textContent;
                    const newValue = formatPercentage(value);
                    element.textContent = newValue;
                    
                    // Apply color classes
                    element.classList.remove('text-success', 'text-danger', 'improvement-positive', 'improvement-negative');
                    if (value > 0.1) {
                        element.classList.add('improvement-positive');
                    } else if (value < 0) {
                        element.classList.add('improvement-negative');
                    }
                    
                    if (oldValue !== newValue) {
                        highlightUpdatedCell(element);
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error updating improvements:', error);
            // Calculate improvements manually from history if available
            calculateImprovementsFromHistory();
        });
}

// Function to highlight a cell that was updated
function highlightUpdatedCell(element) {
    // Remove existing highlight class in case it's already being animated
    element.classList.remove('highlight-update');
    
    // Force a reflow to ensure the animation restarts
    void element.offsetWidth;
    
    // Add the highlight class to start the animation
    element.classList.add('highlight-update');
}

// New function to calculate improvements from history when API fails
function calculateImprovementsFromHistory() {
    if (!metricsHistory || !metricsHistory.global || metricsHistory.global.length < 2) return;
    
    // Calculate global improvement
    const globalHistory = metricsHistory.global;
    const firstAccuracy = globalHistory[0].accuracy || 0;
    const latestAccuracy = globalHistory[globalHistory.length - 1].accuracy || 0;
    const globalImprovement = latestAccuracy - firstAccuracy;
    
    const globalElement = document.getElementById('global-improvement');
    if (globalElement) {
        globalElement.textContent = formatPercentage(globalImprovement);
        if (globalImprovement > 0.1) globalElement.classList.add('text-success');
        else if (globalImprovement < 0) globalElement.classList.add('text-danger');
    }
    
    // Calculate local model improvements
    if (metricsHistory.local) {
        Object.entries(metricsHistory.local).forEach(([modelName, history]) => {
            if (history && history.length >= 2) {
                const firstAccuracy = history[0].accuracy || 0;
                const latestAccuracy = history[history.length - 1].accuracy || 0;
                const improvement = latestAccuracy - firstAccuracy;
                
                const element = document.getElementById(`${modelName}-improvement`);
                if (element) {
                    element.textContent = formatPercentage(improvement);
                    if (improvement > 0.1) element.classList.add('text-success');
                    else if (improvement < 0) element.classList.add('text-danger');
                }
            }
        });
    }
}

function addLogEntry(type, message) {
    const log = document.getElementById('training-log');
    if (!log) return;
    
    const now = new Date();
    const timestamp = now.toLocaleTimeString();
    
    let typeClass = 'text-info';
    if (type === 'ERROR') typeClass = 'text-danger';
    else if (type === 'WARNING') typeClass = 'text-warning';
    else if (type === 'SUCCESS') typeClass = 'text-success';
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="text-muted">[${timestamp}]</span>
        <span class="${typeClass}">[${type}]</span>
        ${message}
    `;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
    
    // Limit log entries to prevent performance issues
    while (log.children.length > 100) {
        log.removeChild(log.firstChild);
    }
}

function clearLog() {
    const logContainer = document.getElementById('training-log');
    logContainer.innerHTML = `
        <div class="log-entry">
            <span class="text-muted">[${new Date().toLocaleTimeString()}]</span>
            <span class="text-info">[INFO]</span>
            Training log cleared.
        </div>
    `;
}

// Enhanced hideLoading function with error checking
function hideLoadingIfStuck() {
    // Check if modal is visible for more than 30 seconds
    const modalElement = document.getElementById('loadingModal');
    if (modalElement && modalElement.classList.contains('show')) {
        console.log('Loading modal appears to be stuck, closing it');
        hideLoading();
        showAlert('Loading operation timed out', 'warning');
        addLogEntry('Loading modal was stuck and automatically closed', 'warning');
    }
}

// Set a periodic check for stuck loading modals
setInterval(hideLoadingIfStuck, 30000);

function formatPercentage(value) {
    if (value === undefined || value === null) return '0.00%';
    return (value * 100).toFixed(2) + '%';
}

function formatDateTime(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatTime(seconds) {
    if (seconds < 60) return seconds.toFixed(1) + 's';
    return Math.floor(seconds / 60) + 'm ' + Math.floor(seconds % 60) + 's';
}

function showLoading(message) {
    // Create loading overlay if it doesn't exist
    let overlay = document.getElementById('loading-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loading-overlay';
        overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '9999';
        document.body.appendChild(overlay);
    }
    
    overlay.innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">${message}</p>
            </div>
        </div>
    `;
    
    // Set a timeout to hide loading after 15 seconds if no response
    setTimeout(() => {
        hideLoading();
    }, 15000);
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function showAlert(message, type = 'info') {
    // Create alert element
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertElement.style.top = '20px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '9999';
    alertElement.style.maxWidth = '400px';
    alertElement.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
    
    // Add icon based on type
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    if (type === 'danger') icon = 'exclamation-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    alertElement.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${icon} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Add to document
    document.body.appendChild(alertElement);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (alertElement.parentNode) {
            alertElement.classList.remove('show');
            setTimeout(() => alertElement.remove(), 300);
        }
    }, 5000);
    
    // Also add to log
    const logType = type === 'success' ? 'SUCCESS' : 
                    type === 'danger' ? 'ERROR' : 
                    type === 'warning' ? 'WARNING' : 'INFO';
    addLogEntry(logType, message);
}
</script>
{% endblock %} 

